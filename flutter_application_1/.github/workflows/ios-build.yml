name: Build iOS App with Widget

on:
  # Run when you push to main branch
  push:
    branches: [ main ]
  
  # Or run manually from GitHub Actions tab
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest  # GitHub's free Mac runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Analyze code
      run: flutter analyze
      continue-on-error: true  # Don't fail if there are warnings
    
    - name: Setup Xcode
      run: |
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
    
    - name: Install CocoaPods
      run: |
        cd ios
        pod install
    
    - name: Build iOS App (No Signing - for widget setup)
      run: |
        flutter build ios --debug --no-codesign
      continue-on-error: true
    
    - name: Create Widget Extension (Manual Setup Required)
      run: |
        echo "‚ö†Ô∏è  Widget Extension needs to be added manually in Xcode"
        echo "This workflow builds the base app. For widget:"
        echo "1. Download the project"
        echo "2. Open ios/Runner.xcworkspace in Xcode"
        echo "3. Add Widget Extension target"
        echo "4. Copy Swift code from IOS_WIDGET_SETUP.md"
        echo "5. Build and run on iPhone"
    
    - name: Archive iOS workspace
      run: |
        cd ios
        zip -r ios-project.zip Runner.xcworkspace Runner/ AtlasWidget/ Podfile Podfile.lock
        mv ios-project.zip ../
    
    - name: Upload iOS Project
      uses: actions/upload-artifact@v3
      with:
        name: ios-project
        path: ios-project.zip
        retention-days: 7
    
    - name: Build Summary
      run: |
        echo "‚úÖ Base Flutter iOS build completed"
        echo "üì¶ Download ios-project.zip from Actions artifacts"
        echo "üçé Open on Mac to add widget extension"
        echo ""
        echo "Next steps:"
        echo "1. Download ios-project.zip"
        echo "2. Extract on Mac"
        echo "3. Open Runner.xcworkspace"
        echo "4. Follow IOS_WIDGET_SETUP.md"
